{% extends "base.html" %}

{% block title %}Smart Goals Dashboard - Nicotine Tracker{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-semibold text-gray-900 dark:text-white">Smart Goals Dashboard</h1>
            <p class="text-sm text-gray-700 dark:text-gray-300">AI-powered flexible goals with gradual reduction plans</p>
        </div>
        <a href="/flexible-goals/create" 
           class="rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
            Create New Goal
        </a>
    </div>

    <!-- AI Recommendations -->
    {% if recommendations %}
    <div class="mt-8">
        <div class="rounded-md bg-blue-50 dark:bg-blue-900/20 p-4 border border-blue-200 dark:border-blue-800">
            <div class="flex">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                        <span class="text-white font-bold text-sm">ðŸ¤–</span>
                    </div>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-medium text-blue-800 dark:text-blue-200">AI Recommendations</h3>
                    <div class="mt-2 text-sm text-blue-700 dark:text-blue-300">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            {% for rec in recommendations %}
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg border border-blue-200 dark:border-blue-700">
                                <h4 class="font-semibold text-blue-700 dark:text-blue-300">{{ rec.name }}</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">{{ rec.description }}</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-xs text-gray-500 dark:text-gray-400">Confidence: {{ (rec.confidence * 100)|round }}%</span>
                                    <button class="create-from-recommendation rounded-md bg-blue-600 px-2 py-1 text-xs font-semibold text-white shadow-sm hover:bg-blue-500"
                                            data-recommendation="{{ rec|tojson|e }}">
                                        Create Goal
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Current Goals -->
    <div class="mt-8">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Your Active Goals</h2>
        
        {% if user_goals %}
        <div class="space-y-4">
            {% for goal in user_goals %}
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white">{{ goal.name }}</h3>
                        <p class="text-sm text-gray-500 dark:text-gray-400">{{ goal.goal_type.replace('_', ' ').title() }}</p>
                    </div>
                    <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium {{ 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400' if goal.is_active else 'bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300' }}">
                        {{ 'Active' if goal.is_active else 'Inactive' }}
                    </span>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                        <dt class="text-gray-500 dark:text-gray-400">Target</dt>
                        <dd class="font-medium text-gray-900 dark:text-white">{{ goal.target_value }}</dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 dark:text-gray-400">Current Streak</dt>
                        <dd class="font-medium text-gray-900 dark:text-white">{{ goal.current_streak }} days</dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 dark:text-gray-400">Best Streak</dt>
                        <dd class="font-medium text-gray-900 dark:text-white">{{ goal.best_streak }} days</dd>
                    </div>
                    <div>
                        <dt class="text-gray-500 dark:text-gray-400">Success Rate</dt>
                        <dd class="font-medium text-gray-900 dark:text-white">{{ goal.calculate_success_rate()|round(1) }}%</dd>
                    </div>
                </div>
                
                {% if goal.goal_type == 'gradual_reduction' %}
                <div class="mt-4 rounded-md bg-blue-50 dark:bg-blue-900/20 p-3">
                    <p class="text-sm text-blue-700 dark:text-blue-300">
                        <span class="font-medium">Gradual reduction:</span> {{ goal.initial_target }} â†’ {{ goal.target_value }} over {{ goal.reduction_frequency }}
                    </p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12">
            <div class="text-gray-400 dark:text-gray-500 text-4xl mb-4">ðŸŽ¯</div>
            <h3 class="text-sm font-medium text-gray-900 dark:text-white">No active goals yet</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Create your first smart goal to get started with AI-powered tracking.
            </p>
            <div class="mt-6">
                <a href="/flexible-goals/create"
                   class="inline-flex items-center rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600">
                    Create First Goal
                </a>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Quick Actions -->
    <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Gradual Reduction Plan -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Create Gradual Reduction Plan</h3>
            <form id="gradual-reduction-form" class="space-y-4">
                <div>
                    <label for="current-avg" class="block text-sm font-medium text-gray-900 dark:text-white">Current Daily Average</label>
                    <input type="number" id="current-avg" name="current_daily_avg" step="0.1" min="0" required
                           class="mt-1 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                </div>
                <div>
                    <label for="target-daily" class="block text-sm font-medium text-gray-900 dark:text-white">Target Daily Amount</label>
                    <input type="number" id="target-daily" name="target_daily" step="0.1" min="0" required
                           class="mt-1 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                </div>
                <div>
                    <label for="weeks-to-achieve" class="block text-sm font-medium text-gray-900 dark:text-white">Weeks to Achieve</label>
                    <input type="number" id="weeks-to-achieve" name="weeks_to_achieve" min="1" max="52" required
                           class="mt-1 block w-full rounded-md border-0 py-1.5 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                </div>
                <button type="submit" 
                        class="w-full rounded-md bg-green-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600">
                    Create Reduction Plan
                </button>
            </form>
        </div>

        <!-- Goal Templates -->
        <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
            <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Goal Templates</h3>
            <div id="goal-templates" class="space-y-3">
                {% if templates %}
                    {% for template in templates %}
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 dark:text-white">{{ template.name }}</h4>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">{{ template.description }}</p>
                        <button class="use-template mt-3 rounded-md bg-indigo-600 px-3 py-1 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
                                data-template-id="{{ template.id }}">
                            Use Template
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-6">
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">No templates available.</p>
                        <button id="initialize-templates" 
                                class="rounded-md bg-gray-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-gray-500">
                            Initialize Default Templates
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle gradual reduction form
    document.getElementById('gradual-reduction-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch('/flexible-goals/gradual-reduction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                alert('Gradual reduction plan created successfully!');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Gradual reduction error:', error);
            alert('Error creating plan. Please try again.');
        });
    });

    // Handle template usage
    document.querySelectorAll('.use-template').forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.dataset.templateId;
            // Redirect to create page with template
            window.location.href = `/flexible-goals/create?template_id=${templateId}`;
        });
    });

    // Handle AI recommendations
    document.querySelectorAll('.create-from-recommendation').forEach(button => {
        button.addEventListener('click', function() {
            const recommendation = JSON.parse(this.dataset.recommendation);
            
            const goalData = {
                name: recommendation.name,
                goal_type: recommendation.type,
                target_value: recommendation.target_value,
                initial_target: recommendation.initial_target,
                reduction_rate: recommendation.reduction_rate
            };

            fetch('/flexible-goals/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(goalData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Goal created from AI recommendation!');
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Create from recommendation error:', error);
                alert('Error creating goal. Please try again.');
            });
        });
    });

    // Initialize templates button
    const initButton = document.getElementById('initialize-templates');
    if (initButton) {
        initButton.addEventListener('click', function() {
            fetch('/flexible-goals/initialize-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Default templates initialized!');
                    location.reload();
                } else {
                    alert('Error initializing templates.');
                }
            })
            .catch(error => {
                console.error('Initialize templates error:', error);
                alert('Error initializing templates.');
            });
        });
    }
});
</script>
{% endblock %}
