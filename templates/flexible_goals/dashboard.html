{% extends "base.html" %}

{% block title %}
Flexible Goals Dashboard - Nicotine Tracker
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">Flexible Goals Dashboard</h1>

    <!-- AI Recommendations -->
    {% if recommendations %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold text-blue-800 mb-4">ðŸ¤– AI Recommendations</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for rec in recommendations %}
            <div class="bg-white p-4 rounded-lg border">
                <h3 class="font-semibold text-blue-700">{{ rec.name }}</h3>
                <p class="text-sm text-gray-600 mb-2">{{ rec.description }}</p>
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">Confidence: {{ (rec.confidence * 100)|round }}%</span>
                    <button class="create-from-recommendation px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700"
                            data-recommendation="{{ rec|tojson|e }}">
                        Create Goal
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Current Goals -->
    <div class="bg-white p-6 rounded-lg shadow-md mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Your Active Goals</h2>
            <a href="/flexible-goals/create" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">
                Create New Goal
            </a>
        </div>
        
        <div id="user-goals" class="space-y-4">
            {% if user_goals %}
                {% for goal in user_goals %}
                <div class="border rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold">{{ goal.name }}</h3>
                        <span class="px-2 py-1 text-xs rounded-full {{ 'bg-green-100 text-green-800' if goal.is_active else 'bg-gray-100 text-gray-800' }}">
                            {{ 'Active' if goal.is_active else 'Inactive' }}
                        </span>
                    </div>
                    
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <div>
                            <span class="text-gray-600">Type:</span>
                            <span class="font-medium">{{ goal.goal_type.replace('_', ' ').title() }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Target:</span>
                            <span class="font-medium">{{ goal.target_value }}</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Current Streak:</span>
                            <span class="font-medium">{{ goal.current_streak }} days</span>
                        </div>
                        <div>
                            <span class="text-gray-600">Success Rate:</span>
                            <span class="font-medium">{{ goal.calculate_success_rate()|round(1) }}%</span>
                        </div>
                    </div>
                    
                    {% if goal.goal_type == 'gradual_reduction' %}
                    <div class="mt-2 text-sm text-blue-600">
                        <span>Gradual reduction: {{ goal.initial_target }} â†’ {{ goal.target_value }} over {{ goal.reduction_frequency }}</span>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <p class="text-gray-600 text-center py-8">No active goals yet. Create your first goal to get started!</p>
            {% endif %}
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Gradual Reduction Plan -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-4">Create Gradual Reduction Plan</h3>
            <form id="gradual-reduction-form" class="space-y-4">
                <div>
                    <label for="current-avg" class="block text-sm font-medium text-gray-700">Current Daily Average</label>
                    <input type="number" id="current-avg" name="current_daily_avg" step="0.1" min="0" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="target-daily" class="block text-sm font-medium text-gray-700">Target Daily Amount</label>
                    <input type="number" id="target-daily" name="target_daily" step="0.1" min="0" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <div>
                    <label for="weeks-to-achieve" class="block text-sm font-medium text-gray-700">Weeks to Achieve</label>
                    <input type="number" id="weeks-to-achieve" name="weeks_to_achieve" min="1" max="52" required
                           class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                </div>
                <button type="submit" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    Create Reduction Plan
                </button>
            </form>
        </div>

        <!-- Goal Templates -->
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-lg font-semibold mb-4">Goal Templates</h3>
            <div id="goal-templates" class="space-y-2">
                {% if templates %}
                    {% for template in templates %}
                    <div class="border rounded p-3">
                        <h4 class="font-medium">{{ template.name }}</h4>
                        <p class="text-sm text-gray-600">{{ template.description }}</p>
                        <button class="use-template mt-2 px-3 py-1 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700"
                                data-template-id="{{ template.id }}">
                            Use Template
                        </button>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-gray-600">No templates available.</p>
                    <button id="initialize-templates" class="mt-2 px-3 py-1 bg-gray-600 text-white text-sm rounded hover:bg-gray-700">
                        Initialize Default Templates
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle gradual reduction form
    document.getElementById('gradual-reduction-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        fetch('/flexible-goals/gradual-reduction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
            } else {
                alert('Gradual reduction plan created successfully!');
                location.reload();
            }
        })
        .catch(error => {
            console.error('Gradual reduction error:', error);
            alert('Error creating plan. Please try again.');
        });
    });

    // Handle template usage
    document.querySelectorAll('.use-template').forEach(button => {
        button.addEventListener('click', function() {
            const templateId = this.dataset.templateId;
            // Redirect to create page with template
            window.location.href = `/flexible-goals/create?template_id=${templateId}`;
        });
    });

    // Handle AI recommendations
    document.querySelectorAll('.create-from-recommendation').forEach(button => {
        button.addEventListener('click', function() {
            const recommendation = JSON.parse(this.dataset.recommendation);
            
            const goalData = {
                name: recommendation.name,
                goal_type: recommendation.type,
                target_value: recommendation.target_value,
                initial_target: recommendation.initial_target,
                reduction_rate: recommendation.reduction_rate
            };

            fetch('/flexible-goals/create', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(goalData)
            })
            .then(response => response.json())
            .then(result => {
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    alert('Goal created from AI recommendation!');
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Create from recommendation error:', error);
                alert('Error creating goal. Please try again.');
            });
        });
    });

    // Initialize templates button
    const initButton = document.getElementById('initialize-templates');
    if (initButton) {
        initButton.addEventListener('click', function() {
            fetch('/flexible-goals/initialize-templates', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Default templates initialized!');
                    location.reload();
                } else {
                    alert('Error initializing templates.');
                }
            })
            .catch(error => {
                console.error('Initialize templates error:', error);
                alert('Error initializing templates.');
            });
        });
    }
});
</script>
{% endblock %}
