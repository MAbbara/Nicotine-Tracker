{% extends "base.html" %}

{% block title %}Settings - Nicotine Tracker{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <h1 class="text-2xl font-semibold text-gray-900 dark:text-white mb-6">Settings</h1>
    
    <!-- Tab Navigation -->
    <div class="border-b border-gray-200 dark:border-gray-700 mb-6">
        <nav class="-mb-px flex space-x-8" aria-label="Tabs">
            <button class="tab-button active border-indigo-500 text-indigo-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm" data-tab="general">
                General
            </button>
            <button class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm dark:text-gray-400 dark:hover:text-gray-300" data-tab="notifications">
                Notifications
            </button>
            <button class="tab-button border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm dark:text-gray-400 dark:hover:text-gray-300" data-tab="integrations">
                Integrations
            </button>
        </nav>
    </div>

    <form method="POST" class="space-y-6" data-validate>
        <!-- General Settings Tab -->
        <div id="general-tab" class="tab-content">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">General Preferences</h3>
                
                <div class="space-y-4">
                    <div>
                        <label for="units_preference" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Units Preference</label>
                        <select name="units_preference" id="units_preference" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                            <option value="mg" {% if user.units_preference == 'mg' %}selected{% endif %}>Milligrams (mg)</option>
                            <option value="percentage" {% if user.units_preference == 'percentage' %}selected{% endif %}>Percentage of max dose</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="timezone" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Time Zone</label>
                        <div class="relative">
                            <select name="timezone" id="timezone" data-hs-select='{
                                "hasSearch": true,
                                "searchPlaceholder": "Search timezones...",
                                "searchClasses": "block w-full text-sm border-gray-200 rounded-lg focus:border-blue-500 focus:ring-blue-500 before:absolute before:inset-0 before:z-[1] dark:bg-slate-900 dark:border-gray-700 dark:text-gray-400 dark:placeholder-gray-500 py-2 px-3",
                                "searchWrapperClasses": "bg-white p-2 -mx-1 sticky top-0 dark:bg-slate-900",
                                "placeholder": "Select timezone...",
                                "toggleTag": "<button type=\"button\"></button>",
                                "toggleClasses": "hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative py-3 px-4 pe-9 flex text-nowrap w-full cursor-pointer bg-white border border-gray-200 rounded-lg text-start text-sm focus:border-blue-500 focus:ring-blue-500 before:absolute before:inset-0 before:z-[1] dark:bg-slate-900 dark:border-gray-700 dark:text-gray-400",
                                "dropdownClasses": "mt-2 max-h-72 pb-1 px-1 space-y-0.5 z-20 w-full bg-white border border-gray-200 rounded-lg overflow-hidden overflow-y-auto dark:bg-slate-900 dark:border-gray-700",
                                "optionClasses": "py-2 px-4 w-full text-sm text-gray-800 cursor-pointer hover:bg-gray-100 rounded-lg focus:outline-none focus:bg-gray-100 dark:bg-slate-900 dark:hover:bg-slate-800 dark:text-gray-200 dark:focus:bg-slate-800",
                                "optionTemplate": "<div class=\"flex justify-between items-center w-full\"><span data-title></span><span class=\"hidden hs-selected:block\"><svg class=\"flex-shrink-0 size-3.5 text-blue-600 dark:text-blue-500\" xmlns=\"http:.w3.org/2000/svg\" width=\"24\" height=\"24\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><polyline points=\"20,6 9,17 4,12\"/></svg></span></div>"
                            }' class="hidden">
                                <option value="">Select timezone...</option>
                                
                                <!-- Common Timezones (marked with ★) -->
                                {% for tz_id, tz_name in common_timezones %}
                                <option value="{{ tz_id }}" {% if user.timezone == tz_id %}selected{% endif %}>★ {{ tz_name }}</option>
                                {% endfor %}
                                
                                <!-- All Timezones -->
                                {% for tz in all_timezones %}
                                <option value="{{ tz.value }}" {% if user.timezone == tz.value %}selected{% endif %}>{{ tz.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label for="daily_reset_time" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Daily Reset Time</label>
                        <input type="time" name="daily_reset_time" id="daily_reset_time" value="{{ preferences.daily_reset_time or '00:00' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Select the time of day when your daily statistics reset (default is midnight).</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Notification Preferences</h3>
                
                <div class="space-y-6">
                    <!-- General Notification Settings -->
                    <div>
                        <label for="notification_channel" class="block text-sm font-medium text-gray-900 dark:text-white">Notification Channel</label>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Choose how you want to receive notifications.</p>
                        <select name="notification_channel" id="notification_channel" class="mt-2 block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                            <option value="none" {% if preferences.notification_channel == 'none' %}selected{% endif %}>None</option>
                            <option value="email" {% if preferences.notification_channel == 'email' %}selected{% endif %}>Email Only</option>
                            <option value="discord" {% if preferences.notification_channel == 'discord' %}selected{% endif %}>Discord Only</option>
                            <option value="both" {% if preferences.notification_channel == 'both' %}selected{% endif %}>Email & Discord</option>
                        </select>
                    </div>

                    <!-- Specific Notification Types -->
                    <div class="space-y-4">

                        <div class="flex items-center justify-between">
                            <div>
                                <label for="goal_notifications" class="text-sm font-medium text-gray-900 dark:text-white">Goal Notifications</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Get notified about goal progress and achievements</p>
                            </div>
                            <input type="checkbox" name="goal_notifications" id="goal_notifications" {% if preferences.goal_notifications %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label for="achievement_notifications" class="text-sm font-medium text-gray-900 dark:text-white">Achievement Notifications</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Celebrate milestones and completed goals</p>
                            </div>
                            <input type="checkbox" name="achievement_notifications" id="achievement_notifications" {% if preferences.achievement_notifications %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label for="daily_reminders" class="text-sm font-medium text-gray-900 dark:text-white">Daily Reminders</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Daily reminders to log your usage</p>
                            </div>
                            <input type="checkbox" name="daily_reminders" id="daily_reminders" {% if preferences.daily_reminders %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>

                        <div class="flex items-center justify-between">
                            <div>
                                <label for="weekly_reports" class="text-sm font-medium text-gray-900 dark:text-white">Weekly Reports</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Weekly summary of your progress</p>
                            </div>
                            <input type="checkbox" name="weekly_reports" id="weekly_reports" {% if preferences.weekly_reports %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>
                    </div>

                    <!-- Notification Timing -->
                    <div class="border-t border-gray-200 dark:border-gray-600 pt-6">
                        <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-4">Notification Timing</h4>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="reminder_time" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Daily Reminder Time</label>
                                <input type="time" name="reminder_time" id="reminder_time" value="{{ preferences.reminder_time or '' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                            </div>
                            
                            <div>
                                <label for="quiet_hours_start" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Quiet Hours Start</label>
                                <input type="time" name="quiet_hours_start" id="quiet_hours_start" value="{{ preferences.quiet_hours_start or '' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                            </div>
                            
                            <div>
                                <label for="quiet_hours_end" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Quiet Hours End</label>
                                <input type="time" name="quiet_hours_end" id="quiet_hours_end" value="{{ preferences.quiet_hours_end or '' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <label for="notification_frequency" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Notification Frequency</label>
                            <select name="notification_frequency" id="notification_frequency" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                                <option value="immediate" {% if preferences.notification_frequency == 'immediate' %}selected{% endif %}>Immediate</option>
                                <option value="daily" {% if preferences.notification_frequency == 'daily' %}selected{% endif %}>Daily Digest</option>
                                <option value="weekly" {% if preferences.notification_frequency == 'weekly' %}selected{% endif %}>Weekly Digest</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Integrations Tab -->
        <div id="integrations-tab" class="tab-content hidden">
            <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 dark:text-white mb-4">External Integrations</h3>
                
                <div class="space-y-6">
                    <!-- Discord Integration -->
                    <div class="border border-gray-200 dark:border-gray-600 rounded-lg p-4">
                        <div class="flex items-center mb-4">
                            <div class="flex-shrink-0">
                                <svg class="h-8 w-8 text-indigo-600" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                                </svg>
                            </div>
                            <div class="ml-4">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white">Discord</h4>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Get notifications in your Discord server</p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <label for="discord_webhook" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Discord Webhook URL</label>
                                <div class="flex gap-2">
                                    <input type="url" name="discord_webhook" id="discord_webhook" value="{{ preferences.discord_webhook or '' }}" class="flex-1 rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600" placeholder="https://discord.com/api/webhooks/...">
                                    <button type="button" id="test-discord-webhook" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-md hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-indigo-900 dark:text-indigo-300 dark:border-indigo-700 dark:hover:bg-indigo-800">
                                        Test
                                    </button>
                                </div>
                                <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                    <a href="https://support.discord.com/hc/en-us/articles/228383668-Intro-to-Webhooks" target="_blank" class="text-indigo-600 hover:text-indigo-500 dark:text-indigo-400">
                                        Learn how to create a Discord webhook →
                                    </a>
                                </p>
                            </div>
                            
                            <div id="discord-test-result" class="hidden">
                                <!-- Test result will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex gap-3 pt-6">
            <button type="submit" class="flex-1 py-2 px-4 inline-flex items-center justify-center gap-x-2 text-sm font-medium rounded-lg border border-transparent bg-indigo-600 text-white hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-600 disabled:opacity-50 disabled:pointer-events-none">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Save Settings
            </button>
            <a href="{{ url_for('dashboard.index') }}" class="py-2 px-4 inline-flex items-center gap-x-2 text-sm font-medium rounded-lg border border-gray-200 bg-white text-gray-800 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 disabled:opacity-50 disabled:pointer-events-none dark:bg-gray-800 dark:border-gray-700 dark:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-600">
                Cancel
            </a>
        </div>
    </form>
</div>

<script>
// Tab functionality
document.addEventListener('DOMContentLoaded', function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabButtons.forEach(button => {
        button.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Update button states
            tabButtons.forEach(btn => {
                btn.classList.remove('active', 'border-indigo-500', 'text-indigo-600');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            });
            
            this.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'hover:border-gray-300');
            this.classList.add('active', 'border-indigo-500', 'text-indigo-600');
            
            // Update content visibility
            tabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            document.getElementById(tabName + '-tab').classList.remove('hidden');
        });
    });
    
    // Discord webhook test functionality
    const testButton = document.getElementById('test-discord-webhook');
    const webhookInput = document.getElementById('discord_webhook');
    const testResult = document.getElementById('discord-test-result');
    
    testButton.addEventListener('click', async function() {
        const webhookUrl = webhookInput.value.trim();
        
        if (!webhookUrl) {
            showTestResult('error', 'Please enter a Discord webhook URL first.');
            return;
        }
        
        // Validate URL format
        if (!webhookUrl.includes('discord.com/api/webhooks/')) {
            showTestResult('error', 'Please enter a valid Discord webhook URL.');
            return;
        }
        
        // Show loading state
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        
        try {
            const response = await fetch('/settings/test-discord-webhook', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ webhook_url: webhookUrl })
            });
            
            const result = await response.json();
            
            if (result.success) {
                showTestResult('success', result.message);
            } else {
                showTestResult('error', result.message);
            }
        } catch (error) {
            showTestResult('error', 'Failed to test webhook. Please check your connection.');
        } finally {
            testButton.disabled = false;
            testButton.textContent = 'Test';
        }
    });
    
    function showTestResult(type, message) {
        testResult.className = `mt-4 p-3 rounded-md ${type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}`;
        testResult.innerHTML = `
            <div class="flex">
                <div class="flex-shrink-0">
                    ${type === 'success' ? 
                        '<svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                        '<svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>'
                    }
                </div>
                <div class="ml-3">
                    <p class="text-sm font-medium">${message}</p>
                </div>
            </div>
        `;
        testResult.classList.remove('hidden');
        
        // Hide after 5 seconds
        setTimeout(() => {
            testResult.classList.add('hidden');
        }, 5000);
    }
});
</script>

{% endblock %}
