{% extends "settings/settings_layout.html" %}

{% block title %}Notifications - Settings{% endblock %}

{% block settings_content %}
<div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg font-medium leading-6 text-gray-900 dark:text-white">
            Notifications
        </h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500 dark:text-gray-400">
            Manage how you receive notifications.
        </p>
    </div>
    <div class="border-t border-gray-200 dark:border-gray-700">
        <form method="POST" action="{{ url_for('settings.notifications') }}">
            <div class="px-4 py-5 sm:p-6 space-y-8">
                <!-- Notification Channels -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 dark:text-white">Channels</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Choose where you receive notifications.</p>
                    <div class="mt-4 space-y-2">
                        <div class="flex items-center">
                            <input id="notification_channel_email" name="notification_channel" type="checkbox" value="email" {% if 'email' in preferences.notification_channel %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                            <label for="notification_channel_email" class="ml-3 block text-sm text-gray-900 dark:text-white">Email</label>
                        </div>
                        <div class="flex items-center">
                            <input id="notification_channel_discord" name="notification_channel" type="checkbox" value="discord" {% if 'discord' in preferences.notification_channel %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                            <label for="notification_channel_discord" class="ml-3 block text-sm text-gray-900 dark:text-white">Discord</label>
                        </div>
                    </div>
                </div>

                <!-- Discord Webhook -->
                <div id="discord-webhook-container" class="{% if 'discord' not in preferences.notification_channel %}hidden{% endif %}">
                    <label for="discord_webhook" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Discord Webhook URL</label>
                    <div class="flex gap-2">
                        <input type="url" name="discord_webhook" id="discord_webhook" value="{{ preferences.discord_webhook or '' }}" class="flex-1 rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600" placeholder="https://discord.com/api/webhooks/...">
                        <button type="button" id="test-discord-webhook" class="px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 border border-indigo-200 rounded-md hover:bg-indigo-100 focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-indigo-900 dark:text-indigo-300 dark:border-indigo-700 dark:hover:bg-indigo-800">
                            Test
                        </button>
                    </div>
                     <div id="discord-test-result" class="hidden mt-2"></div>
                </div>
                
                <!-- Notification Types -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 dark:text-white">Notification Types</h4>
                     <div class="mt-4 space-y-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <label for="goal_notifications" class="text-sm font-medium text-gray-900 dark:text-white">Goal Notifications</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Get notified about goal progress and achievements</p>
                            </div>
                            <input type="checkbox" name="goal_notifications" id="goal_notifications" {% if preferences.goal_notifications %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label for="achievement_notifications" class="text-sm font-medium text-gray-900 dark:text-white">Achievement Notifications</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Celebrate milestones and completed goals</p>
                            </div>
                            <input type="checkbox" name="achievement_notifications" id="achievement_notifications" {% if preferences.achievement_notifications %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label for="daily_reminders" class="text-sm font-medium text-gray-900 dark:text-white">Daily Reminders</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Daily reminders to log your usage</p>
                            </div>
                            <input type="checkbox" name="daily_reminders" id="daily_reminders" {% if preferences.daily_reminders %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>
                        <div class="flex items-center justify-between">
                            <div>
                                <label for="weekly_reports" class="text-sm font-medium text-gray-900 dark:text-white">Weekly Reports</label>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Weekly summary of your progress</p>
                            </div>
                            <input type="checkbox" name="weekly_reports" id="weekly_reports" {% if preferences.weekly_reports %}checked{% endif %} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700">
                        </div>
                    </div>
                </div>

                <!-- Notification Timing -->
                <div>
                    <h4 class="text-md font-medium text-gray-900 dark:text-white">Timing</h4>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="reminder_time" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Daily Reminder Time</label>
                            <input type="time" name="reminder_time" id="reminder_time" value="{{ preferences.reminder_time or '' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                        </div>
                        <div>
                            <label for="quiet_hours_start" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Quiet Hours Start</label>
                            <input type="time" name="quiet_hours_start" id="quiet_hours_start" value="{{ preferences.quiet_hours_start or '' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                        </div>
                        <div>
                            <label for="quiet_hours_end" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Quiet Hours End</label>
                            <input type="time" name="quiet_hours_end" id="quiet_hours_end" value="{{ preferences.quiet_hours_end or '' }}" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="notification_frequency" class="block text-sm font-medium text-gray-900 dark:text-white mb-2">Notification Frequency</label>
                        <select name="notification_frequency" id="notification_frequency" class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm dark:bg-gray-700 dark:text-white dark:ring-gray-600">
                            <option value="immediate" {% if preferences.notification_frequency == 'immediate' %}selected{% endif %}>Immediate</option>
                            <option value="daily" {% if preferences.notification_frequency == 'daily' %}selected{% endif %}>Daily Digest</option>
                            <option value="weekly" {% if preferences.notification_frequency == 'weekly' %}selected{% endif %}>Weekly Digest</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="px-4 py-3 bg-gray-50 dark:bg-gray-800 text-right sm:px-6">
                <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Show/hide Discord webhook input
    const discordCheckbox = document.getElementById('notification_channel_discord');
    const webhookContainer = document.getElementById('discord-webhook-container');
    discordCheckbox.addEventListener('change', () => {
        webhookContainer.classList.toggle('hidden', !discordCheckbox.checked);
    });

    // Discord webhook test functionality
    const testButton = document.getElementById('test-discord-webhook');
    const webhookInput = document.getElementById('discord_webhook');
    const testResult = document.getElementById('discord-test-result');
    
    testButton.addEventListener('click', async function() {
        const webhookUrl = webhookInput.value.trim();
        if (!webhookUrl) {
            showTestResult('error', 'Please enter a Discord webhook URL first.');
            return;
        }
        
        testButton.disabled = true;
        testButton.textContent = 'Testing...';
        
        try {
            const response = await fetch("{{ url_for('settings.test_discord_webhook') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ webhook_url: webhookUrl })
            });
            const result = await response.json();
            showTestResult(result.success ? 'success' : 'error', result.message);
        } catch (error) {
            showTestResult('error', 'Failed to test webhook. Please check your connection.');
        } finally {
            testButton.disabled = false;
            testButton.textContent = 'Test';
        }
    });
    
    function showTestResult(type, message) {
        testResult.className = `p-3 rounded-md ${type === 'success' ? 'bg-green-50 text-green-800 border border-green-200' : 'bg-red-50 text-red-800 border border-red-200'}`;
        testResult.textContent = message;
        testResult.classList.remove('hidden');
        setTimeout(() => testResult.classList.add('hidden'), 5000);
    }
});
</script>
{% endblock %}
